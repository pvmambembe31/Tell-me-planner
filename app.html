<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tell Me Planner - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body>

    <div class="app-container">
        <header class="app-header">
            <div class="user-welcome">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="assets/logo.jpg" style="width: 50px; border-radius: 50%;">
                    <div>
                        <h1 id="greeting">Hello!</h1>
                        <p style="color: var(--text-dim); font-size: 0.9rem;">Organize sua rotina de estudos.</p>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 20px; align-items: center;">
                <div class="xp-wrapper">
                    <div class="lvl-circle">LV<span id="lvlNum">1</span></div>
                    <div class="xp-track">
                        <div class="xp-fill" id="xpBar"></div>
                    </div>
                    <span style="font-size: 0.8rem; font-weight: bold; color: var(--gold);" id="xpText">0 XP</span>
                </div>
                <button onclick="logout()" class="logout-btn">Sair</button>
            </div>
        </header>

        <div class="grid-dashboard">

            <div class="widget">
                <div class="widget-title">
                    <span><i class="ph ph-calendar-check" style="color: var(--magenta);"></i> Check-in Di√°rio</span>
                    <button class="btn-small-action" onclick="resetWeek()"
                        title="Limpa as marca√ß√µes mas mantem o XP">Nova Semana ‚Üª</button>
                </div>
                <div class="week-row">
                    <div class="day-box" onclick="toggleFrequency(0)">
                        <div class="check-circle"></div><span>D</span>
                    </div>
                    <div class="day-box" onclick="toggleFrequency(1)">
                        <div class="check-circle"></div><span>S</span>
                    </div>
                    <div class="day-box" onclick="toggleFrequency(2)">
                        <div class="check-circle"></div><span>T</span>
                    </div>
                    <div class="day-box" onclick="toggleFrequency(3)">
                        <div class="check-circle"></div><span>Q</span>
                    </div>
                    <div class="day-box" onclick="toggleFrequency(4)">
                        <div class="check-circle"></div><span>Q</span>
                    </div>
                    <div class="day-box" onclick="toggleFrequency(5)">
                        <div class="check-circle"></div><span>S</span>
                    </div>
                    <div class="day-box" onclick="toggleFrequency(6)">
                        <div class="check-circle"></div><span>S</span>
                    </div>
                </div>
            </div>

            <div class="widget">
                <div class="widget-title">
                    <span><i class="ph ph-clock" style="color: var(--blue);"></i> Pomodoro Log</span>
                    <button class="btn-small-action" onclick="clearTimerLog()">Limpar Log</button>
                </div>
                <div class="timer-big" id="timerDisplay">25:00</div>
                <div class="timer-actions">
                    <button class="btn-control btn-start" onclick="toggleTimer()">START</button>
                    <button class="btn-control btn-reset" onclick="resetTimer()">RESET</button>
                </div>
                <div class="pomodoro-log" id="pomodoroLog">
                    <div class="log-item">O hist√≥rico aparecer√° aqui...</div>
                </div>
            </div>

            <div class="widget" style="grid-column: 1 / -1;">
                <div class="widget-title">
                    <span><i class="ph ph-list-checks" style="color: var(--gold);"></i> Planejamento da Semana</span>
                </div>

                <div class="day-tabs">
                    <button class="day-tab active" onclick="selectDay(0)">Domingo</button>
                    <button class="day-tab" onclick="selectDay(1)">Segunda</button>
                    <button class="day-tab" onclick="selectDay(2)">Ter√ßa</button>
                    <button class="day-tab" onclick="selectDay(3)">Quarta</button>
                    <button class="day-tab" onclick="selectDay(4)">Quinta</button>
                    <button class="day-tab" onclick="selectDay(5)">Sexta</button>
                    <button class="day-tab" onclick="selectDay(6)">S√°bado</button>
                </div>

                <div class="task-input-group">
                    <input type="text" id="taskInput" class="input-task" placeholder="O que vamos estudar neste dia?">
                    <button class="btn-add" onclick="addTask()">+</button>
                </div>

                <ul class="task-list" id="taskList">
                </ul>
            </div>

        </div>

        <div class="backup-area">
            <button class="btn-backup" onclick="downloadBackup()">
                <i class="ph ph-download-simple"></i> Salvar Progresso (Backup)
            </button>

            <button class="btn-backup btn-restore" onclick="document.getElementById('fileInput').click()">
                <i class="ph ph-upload-simple"></i> Carregar Backup
            </button>
            <input type="file" id="fileInput" style="display: none;" onchange="loadBackup(this)">
        </div>
        <p style="text-align: center; color: var(--text-dim); font-size: 0.8rem; margin-top: 10px;">
            Salve seu arquivo .json caso troque de computador ou limpe o cache.
        </p>

    </div>

    <script src="js/script.js"></script>

    <script>
        // --- SEGURAN√áA B√ÅSICA ---
        if (localStorage.getItem('tmy_planner_unlocked') !== 'true') window.location.href = "index.html";
        function logout() { localStorage.removeItem('tmy_planner_unlocked'); window.location.href = "index.html"; }

        // --- SAUDA√á√ÉO ---
        const h = new Date().getHours();
        document.getElementById('greeting').innerText = h < 12 ? 'Good Morning!' : (h < 18 ? 'Good Afternoon!' : 'Good Evening!');

        // --- ESTADO GLOBAL (DADOS) ---
        const defaultData = {
            xp: 0,
            weekCheck: [false, false, false, false, false, false, false],
            tasks: { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] },
            pomoLog: []
        };

        let data = JSON.parse(localStorage.getItem('tmy_v2_data')) || defaultData;
        if (Array.isArray(data.tasks)) { data = defaultData; }

        let currentDayIdx = new Date().getDay();

        function saveData() {
            localStorage.setItem('tmy_v2_data', JSON.stringify(data));
            renderAll();
        }

        // --- 1. SISTEMA DE XP ---
        function renderXP() {
            const level = Math.floor(data.xp / 100) + 1;
            const progress = data.xp % 100;
            document.getElementById('lvlNum').innerText = level;
            document.getElementById('xpBar').style.width = progress + '%';
            document.getElementById('xpText').innerText = progress + '/100 XP';
        }

        // --- 2. FREQU√äNCIA ---
        function toggleFrequency(dayIdx) {
            data.weekCheck[dayIdx] = !data.weekCheck[dayIdx];
            data.xp += data.weekCheck[dayIdx] ? 20 : -20;
            if (data.xp < 0) data.xp = 0;
            saveData();
        }

        function resetWeek() {
            if (confirm("Iniciar nova semana? Isso limpar√° os checks de frequ√™ncia, mas manter√° seu XP.")) {
                data.weekCheck = [false, false, false, false, false, false, false];
                saveData();
            }
        }

        function renderFrequency() {
            const days = document.querySelectorAll('.week-row .day-box');
            days.forEach((d, i) => {
                if (data.weekCheck[i]) d.classList.add('active');
                else d.classList.remove('active');
            });
        }

        // --- 3. PLANEJAMENTO ---
        function selectDay(dayIdx) {
            currentDayIdx = dayIdx;
            document.querySelectorAll('.day-tab').forEach((tab, i) => {
                if (i === dayIdx) tab.classList.add('active');
                else tab.classList.remove('active');
            });
            renderTasks();
        }

        function addTask() {
            const input = document.getElementById('taskInput');
            if (!input.value.trim()) return;
            data.tasks[currentDayIdx].push({ txt: input.value, done: false });
            input.value = '';
            saveData();
        }

        function toggleTask(taskIdx) {
            const task = data.tasks[currentDayIdx][taskIdx];
            task.done = !task.done;
            data.xp += task.done ? 10 : -10;
            if (data.xp < 0) data.xp = 0;
            saveData();
        }

        function deleteTask(taskIdx, e) {
            e.stopPropagation();
            data.tasks[currentDayIdx].splice(taskIdx, 1);
            saveData();
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            const tasksOfDay = data.tasks[currentDayIdx] || [];

            if (tasksOfDay.length === 0) {
                list.innerHTML = '<li style="color: var(--text-dim); text-align:center; padding: 20px;">Nenhuma miss√£o planejada para este dia.</li>';
                return;
            }

            tasksOfDay.forEach((t, i) => {
                const li = document.createElement('li');
                li.className = `task-item ${t.done ? 'done' : ''}`;
                li.innerHTML = `
                    <span style="flex:1; cursor:pointer;" onclick="toggleTask(${i})">${t.txt}</span>
                    <i class="ph ph-trash trash-icon" style="cursor:pointer;" title="Apagar (XP mantido)" onclick="deleteTask(${i}, event)"></i>
                `;
                list.appendChild(li);
            });
        }

        // --- 4. TIMER & LOG ---
        let timerTime = 1500;
        let timerInt = null;
        const display = document.getElementById('timerDisplay');
        const btnStart = document.querySelector('.btn-start');

        function fmtTime(s) {
            const m = Math.floor(s / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return `${m}:${sec}`;
        }

        function addToLog(msg) {
            const timeNow = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            data.pomoLog.unshift({ time: timeNow, text: msg });
            if (data.pomoLog.length > 20) data.pomoLog.pop();
            saveData();
        }

        function toggleTimer() {
            if (timerInt) {
                clearInterval(timerInt);
                timerInt = null;
                btnStart.innerText = "RESUME";
                btnStart.style.backgroundColor = "#E6007E";
                addToLog("‚è∏Ô∏è Pausou em " + fmtTime(timerTime));
            } else {
                btnStart.innerText = "PAUSE";
                btnStart.style.backgroundColor = "#ff9800";
                addToLog("‚ñ∂Ô∏è Iniciou/Retomou");
                timerInt = setInterval(() => {
                    if (timerTime > 0) {
                        timerTime--;
                        display.innerText = fmtTime(timerTime);
                    } else {
                        clearInterval(timerInt);
                        timerInt = null;
                        alert("Sess√£o Finalizada! +50 XP");
                        data.xp += 50;
                        addToLog("‚úÖ Sess√£o conclu√≠da (+50XP)");
                        saveData();
                        timerTime = 1500;
                        display.innerText = "25:00";
                        btnStart.innerText = "START";
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timerInt);
            timerInt = null;
            timerTime = 1500;
            display.innerText = "25:00";
            btnStart.innerText = "START";
            btnStart.style.backgroundColor = "#E6007E";
            addToLog("üîÑ Timer Resetado");
        }

        function clearTimerLog() {
            data.pomoLog = [];
            saveData();
        }

        function renderLog() {
            const logDiv = document.getElementById('pomodoroLog');
            logDiv.innerHTML = '';
            if (data.pomoLog.length === 0) {
                logDiv.innerHTML = '<div class="log-item">Hist√≥rico vazio.</div>';
                return;
            }
            data.pomoLog.forEach(log => {
                logDiv.innerHTML += `<div class="log-item"><span>${log.time}</span> - ${log.text}</div>`;
            });
        }

        // --- 5. BACKUP ---
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "TellMePlanner_Backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const savedData = JSON.parse(e.target.result);
                    if (savedData.xp !== undefined && savedData.tasks) {
                        data = savedData;
                        saveData();
                        alert("Backup carregado com sucesso!");
                        location.reload();
                    } else {
                        alert("Arquivo inv√°lido.");
                    }
                } catch (err) {
                    alert("Erro ao ler arquivo.");
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('taskInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });

        function renderAll() {
            renderXP();
            renderFrequency();
            selectDay(currentDayIdx);
            renderLog();
        }
        selectDay(currentDayIdx);
        renderAll();

    </script>
</body>

</html>